
@page "/detail-produk/{id:int}"
@inject IProdukService ProdukService
@inject IKeretaService KeretaService
@inject IPesananService PesananService
@inject ILocalStorageService LocalStorage
@inject IToastService ToastService
<h3>DetailProduk</h3>
<div class="media">
    <div class="media-img-big-wrapper mr-2">
        <img class="media-img-big" src="@produk.GambarUrl" />
    </div>
    <div class="media-body">
        <h2 class="mb-0">@produk.Nama</h2>
        <p>@produk.Deskripsi</p>
        <p>
        @if(produk.ProdukVarians != null && produk.ProdukVarians.Count > 1)
        {
            <div class="form-group">
                <select class="form-control" @bind="IdVarianSekarang">
                    @foreach (var varians in produk.ProdukVarians)
                    {
                        <option value="@varians.IdVarian">@varians.Varian.Nama</option>
                    }
                </select>

            </div>
        }
        </p>
        @if (VarianTerpilih != null)
        {
            @if(VarianTerpilih().HargaOriVarian > VarianTerpilih().HargaVarian)
            {
                <h6 class="text-muted orginal-price">@VarianTerpilih().HargaOriVarian</h6>
            }
            <h4 class="text-muted orginal-price">@VarianTerpilih().HargaVarian</h4>
        }
        <h4 class="price">Rp.@produk.Harga </h4>
        <br />
        <EditForm Model="_itemkereta">
            <div class="form-group">
                <InputNumber id="qty" @bind-Value="_itemkereta.Qty" class="form-control" style="width:100px"></InputNumber>
            </div>
        </EditForm>
        <buttion class="btn btn-primary" @onclick="TambahKeranjang">Tambah keranjang  </buttion>
    </div>
</div>
@code {
    [Parameter]
    public int? Id { get; set; }
    Produk produk = new Produk();
    private int IdVarianSekarang = 1;
    private ItemKereta _itemkereta = new ItemKereta { Qty = 1 };
    private int IdPesanTerakhir;

    private ProdukVarian VarianTerpilih()
    {
        var varians = produk.ProdukVarians.FirstOrDefault(v => v.IdVarian == IdVarianSekarang);
        return varians;
    }
    protected override async Task OnParametersSetAsync()
    {
        if(Id != null)
        {
            produk = await ProdukService.GetProduksById((int)Id);
        }
    }
    protected override async Task OnInitializedAsync()
    {
        if (produk.ProdukVarians.Count < 0)
        {
            IdVarianSekarang = produk.ProdukVarians[0].IdVarian;
        }
    }
    private async Task TambahKeranjang()
    {
        var ProdukTerpilih = VarianTerpilih();
        _itemkereta.IdVarian = ProdukTerpilih.IdVarian;
        _itemkereta.NamaVarian = ProdukTerpilih.Varian.Nama;
        _itemkereta.Image = produk.GambarUrl;
        _itemkereta.Harga = ProdukTerpilih.HargaVarian;
        _itemkereta.IdProduk = ProdukTerpilih.IdProduk;
        _itemkereta.NamaProduk = produk.Nama;
        IdPesanTerakhir = await PesananService.GetIdTerakhir();
        _itemkereta.IdPesanan = IdPesanTerakhir + 1;
     
        await KeretaService.TambahKereta(_itemkereta);
    }
}
